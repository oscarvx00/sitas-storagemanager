FROM amazoncorretto:17-alpine3.15
WORKDIR "/sitas-storagemanager-e2e-test"

RUN apk update
RUN apk add python3
RUN apk add py3-pip

COPY requirements.txt ./
RUN pip install -r requirements.txt

COPY e2etest.py ./
COPY 7f596b76.mp3 ./

COPY entrypoint.sh ./
RUN chmod +x entrypoint.sh

COPY *.jar ./

ARG MONGODB_ENDPOINT
ARG MONGODB_DATABASE
ARG MINIO_INTERNAL_ENDPOINT
ARG MINIO_INTERNAL_USER
ARG MINIO_INTERNAL_PASS
ARG MINIO_INTERNAL_BUCKET
ARG RABBITMQ_ENDPOINT
ARG RABBITMQ_USER
ARG RABBITMQ_PASS
ARG RABBITMQ_VHOST
ARG RABBITMQ_QUEUE_DOWNLOADCOMPLETED
ARG MINIO_NODE_ENDPOINT
ARG MINIO_NODE_USER
ARG MINIO_NODE_PASS
ARG MINIO_NODE_BUCKET

ENV MONGODB_ENDPOINT=${MONGODB_ENDPOINT}
ENV MONGODB_DATABASE=${MONGODB_DATABASE}
ENV MINIO_INTERNAL_ENDPOINT=${MINIO_INTERNAL_ENDPOINT}
ENV MINIO_INTERNAL_USER=${MINIO_INTERNAL_USER}
ENV MINIO_INTERNAL_PASS=${MINIO_INTERNAL_PASS}
ENV MINIO_INTERNAL_BUCKET=${MINIO_INTERNAL_BUCKET}
ENV RABBITMQ_ENDPOINT=${RABBITMQ_ENDPOINT}
ENV RABBITMQ_USER=${RABBITMQ_USER}
ENV RABBITMQ_PASS=${RABBITMQ_PASS}
ENV RABBITMQ_VHOST=${RABBITMQ_VHOST}
ENV RABBITMQ_QUEUE_DOWNLOADCOMPLETED=${RABBITMQ_QUEUE_DOWNLOADCOMPLETED}
ENV MINIO_NODE_ENDPOINT=${MINIO_NODE_ENDPOINT}
ENV MINIO_NODE_USER=${MINIO_NODE_USER}
ENV MINIO_NODE_PASS=${MINIO_NODE_PASS}
ENV MINIO_NODE_BUCKET=${MINIO_NODE_BUCKET}

ENTRYPOINT ["sh", "./entrypoint.sh"]